"use client"

import React, { useEffect, useState, useCallback } from "react"
import { useParams, useRouter } from "next/navigation"
import { Button } from "@/components/ui/button"
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card"
import { Input } from "@/components/ui/input"
import { Label } from "@/components/ui/label"
import { Alert, AlertDescription } from "@/components/ui/alert"
import { Badge } from "@/components/ui/badge"
import { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle } from "@/components/ui/dialog"
import { Wallet, Clock, TrendingUp, AlertCircle, Package } from "lucide-react"
import { auctionAPI } from "@/lib/api"
import type { GuestData, RoundResults } from "@/types/auction"
import { toast } from "@/hooks/use-toast"
import { useConnectionMonitor } from "@/hooks/use-connection-monitor"
import { useCleanup } from "@/hooks/use-cleanup"
import { useOfflineHandler } from "@/hooks/use-offline-handler"
import { DataValidator } from "@/lib/data-validation"
import { GuestLayout } from "@/components/guest-layout"
import { AuctionItemProvider } from "@/contexts/auction-item-context"
import { useCurrentRoundItem } from "@/stores/auction-store"
import { useAuctionRealtime } from "@/hooks/use-supabase-realtime"

export default function DynamicGuestRoom() {
  const params = useParams()
  const roomId = params.roomId as string
  const router = useRouter()

  const [isConnected, setIsConnected] = useState(false)
  const [showJoinModal, setShowJoinModal] = useState(true)
  const [nickname, setNickname] = useState("")
  const [isJoining, setIsJoining] = useState(false)
  const [guestData, setGuestData] = useState<GuestData | null>(null)
  const [bidAmount, setBidAmount] = useState("")
  const [isBidding, setIsBidding] = useState(false)
  const [error, setError] = useState("")
  const [roundResults, setRoundResults] = useState<RoundResults | null>(null)
  const [canBid, setCanBid] = useState(true)
  const [previousStateHash, setPreviousStateHash] = useState("")
  const [currentRoundItem, setCurrentRoundItem] = useState<any>(null)
  const storeCurrentRoundItem = useCurrentRoundItem()
  const [isItemDialogOpen, setIsItemDialogOpen] = useState(false)
  
  // Ïó∞Í≤∞ ÏÉÅÌÉú Î™®ÎãàÌÑ∞ÎßÅ
  const { connectionState, recordRequest } = useConnectionMonitor({
    onConnectionLost: () => {
      toast({
        title: "Ïó∞Í≤∞ ÎÅäÍπÄ",
        description: "ÏÑúÎ≤ÑÏôÄÏùò Ïó∞Í≤∞Ïù¥ ÎÅäÏñ¥Ï°åÏäµÎãàÎã§. ÏûêÎèôÏúºÎ°ú Ïû¨Ïó∞Í≤∞ÏùÑ ÏãúÎèÑÌï©ÎãàÎã§.",
        variant: "destructive",
      })
    },
    onConnectionRestored: () => {
      toast({
        title: "Ïó∞Í≤∞ Î≥µÍµ¨",
        description: "ÏÑúÎ≤ÑÏôÄÏùò Ïó∞Í≤∞Ïù¥ Î≥µÍµ¨ÎêòÏóàÏäµÎãàÎã§.",
      })
    }
  })

  // Ïò§ÌîÑÎùºÏù∏ Ï≤òÎ¶¨
  const { isOffline, queueAction } = useOfflineHandler({
    onOffline: () => {
      toast({
        title: "Ïò§ÌîÑÎùºÏù∏ ÏÉÅÌÉú",
        description: "Ïù∏ÌÑ∞ÎÑ∑ Ïó∞Í≤∞Ïù¥ ÎÅäÏñ¥Ï°åÏäµÎãàÎã§. Ïó∞Í≤∞Ïù¥ Î≥µÍµ¨ÎêòÎ©¥ ÏûêÎèôÏúºÎ°ú ÎèôÍ∏∞ÌôîÎê©ÎãàÎã§.",
        variant: "destructive",
      })
    }
  })

  // Ï†ïÎ¶¨ Î°úÏßÅ
  const { createInterval, createTimeout, cleanup } = useCleanup({
    onUnmount: () => {
      console.log("[DynamicGuest] Component unmounting, cleaning up resources")
    }
  })

  // ÌòÑÏû¨ ÎùºÏö¥ÎìúÏùò Í≤ΩÎß§ Î¨ºÌíà Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
  const loadCurrentRoundItem = useCallback(async () => {
    try {
      const response = await auctionAPI.getCurrentRoundItem(roomId)
      if (response.success) {
        setCurrentRoundItem(response.currentRoundItem)
        console.log("[DynamicGuest] Current round item loaded:", response.currentRoundItem)
      }
    } catch (error) {
      console.error("[DynamicGuest] Failed to load current round item:", error)
    }
  }, [roomId])

  useEffect(() => {
    if (storeCurrentRoundItem) setCurrentRoundItem(storeCurrentRoundItem)
  }, [storeCurrentRoundItem])
  const [currentHighestBid, setCurrentHighestBid] = useState<any>(null)

  // Supabase Realtime Íµ¨ÎèÖ - ÎùºÏö¥Îìú ÏÉÅÌÉú Î≥ÄÌôî Ïã§ÏãúÍ∞Ñ Í∞êÏßÄ
  useAuctionRealtime(roomId, {
    onRoomUpdate: (room) => {
      console.log("[DynamicGuest Realtime] Room updated:", room)
      
      // Ï¶âÏãú Í≤åÏä§Ìä∏ Îç∞Ïù¥ÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏
      if (guestData) {
        const previousStatus = guestData.status
        const previousRoundStatus = guestData.roundStatus
        const previousRound = guestData.currentRound
        
        setGuestData(prev => prev ? {
          ...prev,
          status: room.status,
          currentRound: room.current_round,
          roundStatus: room.round_status
        } : null)
        
        // ÎùºÏö¥Îìú ÏãúÏûë Í∞êÏßÄ
        if (room.round_status === 'ACTIVE' && previousRoundStatus !== 'ACTIVE') {
          console.log('[DynamicGuest Realtime] ÎùºÏö¥Îìú ÏãúÏûë Í∞êÏßÄ!')
          toast({
            title: "üî• Î≥ÄÎèôÏûÖÏ∞∞ ÎùºÏö¥Îìú ÏãúÏûë!",
            description: `ÎùºÏö¥Îìú ${room.current_round}Ïù¥ ÏãúÏûëÎêòÏóàÏäµÎãàÎã§. Ïã§ÏãúÍ∞ÑÏúºÎ°ú ÏûÖÏ∞∞ÌïòÏÑ∏Ïöî!`,
          })
          setCanBid(true)
          setRoundResults(null)
          loadCurrentRoundItem()
        } 
        // ÎùºÏö¥Îìú Ï¢ÖÎ£å Í∞êÏßÄ
        else if (room.round_status !== 'ACTIVE' && previousRoundStatus === 'ACTIVE') {
          console.log('[DynamicGuest Realtime] ÎùºÏö¥Îìú Ï¢ÖÎ£å Í∞êÏßÄ!')
          toast({
            title: "ÎùºÏö¥Îìú Ï¢ÖÎ£å",
            description: `ÎùºÏö¥Îìú ${room.current_round}Ïù¥ Ï¢ÖÎ£åÎêòÏóàÏäµÎãàÎã§.`,
          })
        } 
        // ÎùºÏö¥Îìú Î≤àÌò∏ Î≥ÄÍ≤Ω Í∞êÏßÄ
        else if (room.current_round !== previousRound && room.current_round > previousRound) {
          console.log('[DynamicGuest Realtime] ÎùºÏö¥Îìú Î≥ÄÍ≤Ω Í∞êÏßÄ!')
          loadCurrentRoundItem()
        }
        
        // Í≤ΩÎß§ ÏÉÅÌÉú Î≥ÄÌôî
        if (room.status === 'ACTIVE' && previousStatus !== 'ACTIVE') {
          toast({
            title: "üéØ Î≥ÄÎèôÏûÖÏ∞∞ Í≤ΩÎß§ ÏãúÏûë!",
            description: "Î≥ÄÎèôÏûÖÏ∞∞ Í≤ΩÎß§Í∞Ä ÏãúÏûëÎêòÏóàÏäµÎãàÎã§. Ïñ∏Ï†úÎì† Ïû¨ÏûÖÏ∞∞Ìï† Ïàò ÏûàÏäµÎãàÎã§!",
          })
        } else if (room.status === 'ENDED' && previousStatus !== 'ENDED') {
          toast({
            title: "Í≤ΩÎß§ Ï¢ÖÎ£å",
            description: "Í≤ΩÎß§Í∞Ä Ï¢ÖÎ£åÎêòÏóàÏäµÎãàÎã§.",
          })
        }
        
        // ÌòÑÏû¨ ÏïÑÏù¥ÌÖú Î≥ÄÍ≤Ω
        if (room.current_item) {
          loadCurrentRoundItem()
        }
      }
    },
    onGuestJoin: (guest) => {
      console.log("[DynamicGuest Realtime] Guest joined:", guest)
    },
    onGuestLeave: (guest) => {
      console.log("[DynamicGuest Realtime] Guest left:", guest)
    },
    onBidPlaced: (bid) => {
      console.log("[DynamicGuest Realtime] Bid placed:", bid)
      // Î≥ÄÎèôÏûÖÏ∞∞ÏóêÏÑúÎäî Îã§Î•∏ ÏÇ¨ÎûåÏùò ÏûÖÏ∞∞ ÏïåÎ¶ºÏù¥ Ï§ëÏöî
      if (bid.nickname !== guestData?.nickname) {
        toast({
          title: "üö® ÏÉàÎ°úÏö¥ ÏûÖÏ∞∞!",
          description: `${bid.nickname}ÎãòÏù¥ ${bid.amount.toLocaleString()}ÏõêÏóê ÏûÖÏ∞∞ÌñàÏäµÎãàÎã§!`,
        })
      }
    },
    onItemAdded: (item) => {
      console.log("[DynamicGuest Realtime] Item added:", item)
      loadCurrentRoundItem()
    }
  })

  // Check if room exists on mount and poll for updates
  useEffect(() => {
    let previousState: any = null
    let isPolling = true
    let retryCount = 0
    let consecutiveErrors = 0
    const maxRetries = 10 // Increased retry count
    const maxConsecutiveErrors = 5 // Allow more consecutive errors

    const checkRoomAndPoll = async () => {
      if (!isPolling) return
      
      try {
        console.log("[Dynamic Guest] Polling room state for roomId:", roomId)
        const response = await auctionAPI.getState(roomId)
        console.log("[Dynamic Guest] Poll response:", response)
        
        if (response.success) {
          console.log("[Dynamic Guest] Connection successful!")
          setIsConnected(true)
          setError("") // Clear any previous errors
          retryCount = 0 // Reset retry count on success
          consecutiveErrors = 0 // Reset consecutive error count
          
          // If guest is already joined, update their data
          if (guestData) {
            const currentGuest = response.state.guests.find(g => g.nickname === guestData.nickname)
            console.log("[Dynamic Guest] Current guest found:", currentGuest)
            
            if (currentGuest) {
              const newGuestData = {
                ...guestData,
                capital: currentGuest.capital,
                status: response.state.status,
                currentRound: response.state.currentRound,
                roundStatus: response.state.roundStatus,
                hasBidInCurrentRound: currentGuest.hasBidInCurrentRound
              }
              
              console.log("[Dynamic Guest] Updating guest data:", newGuestData)
              setGuestData(newGuestData)

              // Update current highest bid
              if (response.state.currentHighestBid) {
                setCurrentHighestBid(response.state.currentHighestBid)
              } else {
                setCurrentHighestBid(null)
              }
              
              // Î≥ÄÎèôÏûÖÏ∞∞ÏóêÏÑúÎäî Ìï≠ÏÉÅ ÏûÖÏ∞∞ Í∞ÄÎä• (ÎùºÏö¥ÎìúÍ∞Ä ÌôúÏÑ±ÏÉÅÌÉúÏù¥Í≥† ÏûêÎ≥∏Ïù¥ ÏûàÏúºÎ©¥)
              const dynamicCanBid = response.state.roundStatus === "ACTIVE" && currentGuest.capital > 0
              console.log("[Dynamic Guest] Dynamic bid - always setting canBid to:", dynamicCanBid)
              setCanBid(dynamicCanBid)
              
              // ÌòÑÏû¨ ÎùºÏö¥ÎìúÏùò Í≤ΩÎß§ Î¨ºÌíà Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
              loadCurrentRoundItem()
              
              console.log("[DynamicGuest] State updated:", {
                status: response.state.status,
                roundStatus: response.state.roundStatus,
                currentRound: response.state.currentRound,
                canBid: dynamicCanBid,
                capital: currentGuest.capital
              })
              
              // Check for state changes and show notifications
              if (previousState) {
                console.log("[Dynamic Guest] Previous state:", previousState)
                console.log("[Dynamic Guest] Current state:", response.state)

                // Î≥ÄÎèôÏûÖÏ∞∞ÏóêÏÑú ÏûêÏã†Ïùò ÏûÖÏ∞∞Ïù¥ Ï∂îÏõîÎêòÏóàÎäîÏßÄ ÌôïÏù∏
                if (response.state.roundStatus === "ACTIVE") {
                  const previousMyBid = previousState.currentHighestBid?.nickname === guestData.nickname
                  const currentMyBid = response.state.currentHighestBid?.nickname === guestData.nickname
                  
                  // Ïù¥Ï†ÑÏóêÎäî ÏµúÍ≥† ÏûÖÏ∞∞ÏûêÏòÄÎäîÎç∞ ÏßÄÍ∏àÏùÄ ÏïÑÎãå Í≤ΩÏö∞
                  if (previousMyBid && !currentMyBid && response.state.currentHighestBid) {
                    toast({
                      title: "ÏûÖÏ∞∞Ïù¥ Ï∂îÏõîÎêòÏóàÏäµÎãàÎã§",
                      description: `${response.state.currentHighestBid.nickname}ÎãòÏù¥ ${response.state.currentHighestBid.amount.toLocaleString()}ÏõêÏúºÎ°ú ÏûÖÏ∞∞ÌñàÏäµÎãàÎã§. Îçî ÎÜíÏùÄ Í∏àÏï°ÏúºÎ°ú Ïû¨ÏûÖÏ∞∞ÌïòÏÑ∏Ïöî!`,
                      variant: "destructive",
                    })
                  }
                }
                
                // Auction started
                if (previousState.status === "PRE-START" && response.state.status === "ACTIVE") {
                  console.log("[Dynamic Guest] Auction started!")
                  toast({
                    title: "Î≥ÄÎèôÏûÖÏ∞∞ Í≤ΩÎß§ ÏãúÏûë",
                    description: "Î≥ÄÎèôÏûÖÏ∞∞ Í≤ΩÎß§Í∞Ä ÏãúÏûëÎêòÏóàÏäµÎãàÎã§! Ìò∏Ïä§Ìä∏Í∞Ä ÎùºÏö¥ÎìúÎ•º ÏãúÏûëÌïòÎ©¥ ÏûÖÏ∞∞Ìï† Ïàò ÏûàÏäµÎãàÎã§.",
                  })
                }
                
                // Round started
                if (previousState.currentRound < response.state.currentRound && response.state.roundStatus === "ACTIVE") {
                  console.log("[Dynamic Guest] Round started!")
                  toast({
                    title: "ÎùºÏö¥Îìú ÏãúÏûë",
                    description: `ÎùºÏö¥Îìú ${response.state.currentRound}Ïù¥ ÏãúÏûëÎêòÏóàÏäµÎãàÎã§! Î≥ÄÎèôÏûÖÏ∞∞Î°ú Ïã§ÏãúÍ∞Ñ Ïû¨ÏûÖÏ∞∞Ïù¥ Í∞ÄÎä•Ìï©ÎãàÎã§.`,
                  })
                  setRoundResults(null) // Clear previous round results
                }
                
                // Round ended (ACTIVE -> NON-ACTIVE: WAITING/ENDED Î™®Îëê Ï≤òÎ¶¨)
                if (previousState.roundStatus === "ACTIVE" && response.state.roundStatus !== "ACTIVE") {
                  console.log("[Dynamic Guest] Round ended!")
                  // Get round results from the latest bids
                  const roundBids = response.state.bids.filter((bid: any) => bid.round === response.state.currentRound)
                  const roundResults = {
                    round: response.state.currentRound,
                    bids: roundBids.sort((a: any, b: any) => b.amount - a.amount),
                    winner: roundBids.length > 0 ? roundBids.reduce((max: any, bid: any) => bid.amount > max.amount ? bid : max) : null
                  }
                  
                  console.log("[Dynamic Guest] Round results:", roundResults)
                  setRoundResults(roundResults)
                  
                  if (roundResults.winner) {
                    toast({
                      title: "ÎùºÏö¥Îìú Ï¢ÖÎ£å",
                      description: `ÎùºÏö¥Îìú ${response.state.currentRound} Ï¢ÖÎ£å! ÏµúÍ≥† ÏûÖÏ∞∞Ïûê: ${roundResults.winner.nickname} (${roundResults.winner.amount?.toLocaleString()}Ïõê)`,
                    })
                  } else {
                    toast({
                      title: "ÎùºÏö¥Îìú Ï¢ÖÎ£å",
                      description: `ÎùºÏö¥Îìú ${response.state.currentRound} Ï¢ÖÎ£å! ÏûÖÏ∞∞ÏûêÍ∞Ä ÏóÜÏóàÏäµÎãàÎã§.`,
                    })
                  }
                }
              }
              
              previousState = response.state
            } else {
              console.log("[Dynamic Guest] Guest not found in room, might have been removed")
              // Guest was removed from room - but don't immediately disconnect
              // Wait for many more polls to confirm
              consecutiveErrors++
              if (consecutiveErrors >= 10) { // Increased threshold
                console.log("[Dynamic Guest] Guest consistently not found, but not disconnecting")
                // Don't disconnect, just show warning
                setError("Ïó∞Í≤∞ ÏÉÅÌÉúÎ•º ÌôïÏù∏ÌïòÎäî Ï§ë...")
              }
            }
          }
        } else {
          console.log("[Dynamic Guest] Room not found or error:", response.error)
          consecutiveErrors++
          retryCount++
          
          // If room not found, redirect to home after some attempts
          if (response.error === "Room not found" && consecutiveErrors >= 5) {
            console.log("[Dynamic Guest] Room not found, redirecting to home")
            toast({
              title: "Î∞©ÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§",
              description: "Ï°¥Ïû¨ÌïòÏßÄ ÏïäÎäî Î∞©ÏûÖÎãàÎã§. ÌôàÏúºÎ°ú Ïù¥ÎèôÌï©ÎãàÎã§.",
              variant: "destructive",
            })
            setTimeout(() => {
              router.push("/")
            }, 2000)
            return
          }
          
          // Only show error after many consecutive failures
          if (consecutiveErrors >= maxConsecutiveErrors) {
            console.log("[Dynamic Guest] Many consecutive errors, but not disconnecting")
            setError("Ïó∞Í≤∞ ÏÉÅÌÉúÎ•º ÌôïÏù∏ÌïòÎäî Ï§ë...")
          }
          
          // Never disconnect due to room not found - keep trying
          console.log("[Dynamic Guest] Room error, but continuing to poll... attempt", retryCount)
        }
      } catch (error) {
        console.error("[Dynamic Guest] Failed to check room:", error)
        consecutiveErrors++
        retryCount++
        
        // Never disconnect due to network errors - keep trying
        console.log("[Dynamic Guest] Network error, but continuing to poll... attempt", retryCount)
        setError("Ïó∞Í≤∞ ÏÉÅÌÉúÎ•º ÌôïÏù∏ÌïòÎäî Ï§ë...")
      }
    }

    // Initial check
    checkRoomAndPoll()
    
    // Poll every 1 second for backup (RealtimeÏù¥ Ï£º Î∞©Î≤ï, Ìè¥ÎßÅÏùÄ Î≥¥Ï°∞)
    const interval = createInterval(checkRoomAndPoll, 1000)

    return () => {
      isPolling = false
      // createIntervalÎ°ú ÏÉùÏÑ±Îêú intervalÏùÄ ÏûêÎèôÏúºÎ°ú Ï†ïÎ¶¨Îê®
    }
  }, [roomId, guestData?.nickname])

  const handleJoinRoom = async () => {
    if (!nickname.trim()) {
      setError("ÎãâÎÑ§ÏûÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.")
      return
    }

    if (nickname.trim().length > 10) {
      setError("ÎãâÎÑ§ÏûÑÏùÄ 10Ïûê Ïù¥ÌïòÎ°ú ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.")
      return
    }

    setIsJoining(true)
    setError("")
    
    try {
      const response = await auctionAPI.joinRoom(roomId, nickname.trim())
      if (response.success) {
        console.log("[Dynamic Guest] Guest joined successfully:", response)
        setGuestData(response)
        setCanBid(true) // Î≥ÄÎèôÏûÖÏ∞∞ÏóêÏÑúÎäî Í∏∞Î≥∏Ï†ÅÏúºÎ°ú ÏûÖÏ∞∞ Í∞ÄÎä•
        setShowJoinModal(false)
        setIsJoining(false)
        
        // Ï¶âÏãú ÏÉÅÌÉú ÌôïÏù∏ÏùÑ ÏúÑÌï¥ Ï∂îÍ∞Ä Ìè¥ÎßÅ Ïã§Ìñâ
        setTimeout(async () => {
          try {
            const stateResponse = await auctionAPI.getState(roomId)
            if (stateResponse.success) {
              const currentGuest = stateResponse.state.guests.find(g => g.nickname === response.nickname)
              if (currentGuest) {
                setGuestData(prev => prev ? {
                  ...prev,
                  capital: currentGuest.capital,
                  status: stateResponse.state.status,
                  currentRound: stateResponse.state.currentRound,
                  roundStatus: stateResponse.state.roundStatus,
                  hasBidInCurrentRound: currentGuest.hasBidInCurrentRound
                } : null)
                setCanBid(!currentGuest.hasBidInCurrentRound)
              }
            }
          } catch (error) {
            console.error("[DynamicGuest] Failed to update state after join:", error)
          }
        }, 500) // 0.5Ï¥à ÌõÑ Ï¶âÏãú ÏÉÅÌÉú ÌôïÏù∏
        
        // Ìò∏Ïä§Ìä∏ ÌéòÏù¥ÏßÄÏóê Ï∞∏Í∞ÄÏûê Ï∞∏Ïó¨ ÏïåÎ¶ºÏùÑ ÏúÑÌïú Ï∂îÍ∞Ä ÏöîÏ≤≠
        setTimeout(async () => {
          try {
            // Ìò∏Ïä§Ìä∏ ÌéòÏù¥ÏßÄÍ∞Ä Ï∞∏Í∞ÄÏûê Ï∞∏Ïó¨Î•º Í∞êÏßÄÌï† Ïàò ÏûàÎèÑÎ°ù Ï∂îÍ∞Ä ÏöîÏ≤≠
            await auctionAPI.getState(roomId)
            console.log("[DynamicGuest] Notified host of participation")
          } catch (error) {
            console.error("[DynamicGuest] Failed to notify host of participation:", error)
          }
        }, 1000) // 1Ï¥à ÌõÑ Ìò∏Ïä§Ìä∏ ÏïåÎ¶º
        
        // Ï∂îÍ∞Ä ÏïåÎ¶º ÏöîÏ≤≠ (Îçî ÌôïÏã§Ìïú ÎèôÍ∏∞Ìôî) - Ïó¨Îü¨ Î≤à Ìò∏Ï∂ú
        const notifyHost = async (attempt: number) => {
          try {
            await auctionAPI.getState(roomId)
            console.log(`[DynamicGuest] Notification ${attempt} sent to host`)
          } catch (error) {
            console.error(`[DynamicGuest] Failed to send notification ${attempt}:`, error)
          }
        }
        
        setTimeout(() => notifyHost(2), 1500) // 1.5Ï¥à ÌõÑ
        setTimeout(() => notifyHost(3), 3000) // 3Ï¥à ÌõÑ  
        setTimeout(() => notifyHost(4), 5000) // 5Ï¥à ÌõÑ
        
        toast({
          title: "Ï∞∏Ïó¨ ÏôÑÎ£å",
          description: `${response.nickname}ÎãòÏúºÎ°ú Î≥ÄÎèôÏûÖÏ∞∞ Í≤ΩÎß§Ïóê Ï∞∏Ïó¨ÌñàÏäµÎãàÎã§.`,
        })
        
        // ÌòÑÏû¨ ÎùºÏö¥Îìú Î¨ºÌíà Ï†ïÎ≥¥ Î°úÎìú
        loadCurrentRoundItem()
      } else {
        setError(response.error || "Ï∞∏Ïó¨Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.")
        setIsJoining(false)
      }
    } catch (error) {
      console.error("Failed to join room:", error)
      setError("ÏÑúÎ≤ÑÏóê Ïó∞Í≤∞Ìï† Ïàò ÏóÜÏäµÎãàÎã§.")
      setIsJoining(false)
    }
  }

  const handlePlaceBid = async () => {
    if (!guestData) return

    console.log("[Dynamic Guest] Place bid check:", {
      canBid,
      roundStatus: guestData.roundStatus,
      capital: guestData.capital,
      hasBidInCurrentRound: guestData.hasBidInCurrentRound
    })

    // Î≥ÄÎèôÏûÖÏ∞∞ÏóêÏÑúÎäî canBid ÎåÄÏã† ÏßÅÏ†ë Ï°∞Í±¥ Ï≤¥ÌÅ¨
    if (guestData.roundStatus !== "ACTIVE") {
      toast({
        title: "ÏûÖÏ∞∞ Î∂àÍ∞Ä",
        description: "ÌòÑÏû¨ ÎùºÏö¥ÎìúÍ∞Ä ÌôúÏÑ±ÌôîÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.",
        variant: "destructive",
      })
      return
    }

    if (guestData.capital <= 0) {
      toast({
        title: "ÏûÖÏ∞∞ Î∂àÍ∞Ä",
        description: "ÏûêÎ≥∏Ïù¥ Î∂ÄÏ°±Ìï©ÎãàÎã§.",
        variant: "destructive",
      })
      return
    }

    const amount = Number.parseInt(bidAmount)
    if (isNaN(amount) || amount <= 0) {
      toast({
        title: "ÏûÖÎ†• Ïò§Î•ò",
        description: "Ïò¨Î∞îÎ•∏ ÏûÖÏ∞∞ Í∏àÏï°ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.",
        variant: "destructive",
      })
      return
    }

    if (amount > guestData.capital) {
      toast({
        title: "ÏûÖÏ∞∞ Î∂àÍ∞Ä",
        description: "Î≥¥Ïú† ÏûêÎ≥∏Î≥¥Îã§ ÎßéÏùÄ Í∏àÏï°ÏùÑ ÏûÖÏ∞∞Ìï† Ïàò ÏóÜÏäµÎãàÎã§.",
        variant: "destructive",
      })
      return
    }

    // Î≥ÄÎèôÏûÖÏ∞∞ÏóêÏÑúÎäî ÌòÑÏû¨ ÏµúÍ≥† ÏûÖÏ∞∞Í∞ÄÎ≥¥Îã§ ÎÜíÏïÑÏïº Ìï®
    if (currentHighestBid && amount <= currentHighestBid.amount) {
      toast({
        title: "ÏûÖÏ∞∞ Î∂àÍ∞Ä",
        description: `ÌòÑÏû¨ ÏµúÍ≥† ÏûÖÏ∞∞Í∞Ä(${currentHighestBid.amount.toLocaleString()}Ïõê)Î≥¥Îã§ ÎÜíÏùÄ Í∏àÏï°ÏùÑ ÏûÖÏ∞∞Ìï¥Ïïº Ìï©ÎãàÎã§.`,
        variant: "destructive",
      })
      return
    }

    setIsBidding(true)
    
    try {
      console.log("[Dynamic Guest] Placing bid:", { roomId, nickname: guestData.nickname, amount })
      const response = await auctionAPI.placeBid(roomId, guestData.nickname, amount, guestData.currentRound || 1, 'dynamic')
      console.log("[Dynamic Guest] Bid response:", response)
      
      if (response.success) {
        // ÏµúÍ≥† ÏûÖÏ∞∞ Ï†ïÎ≥¥ Î®ºÏ†Ä ÏóÖÎç∞Ïù¥Ìä∏ (Ïã§ÏãúÍ∞Ñ Î∞òÏòÅ)
        if (response.state?.currentHighestBid) {
          setCurrentHighestBid(response.state.currentHighestBid)
        }

        // Update guest data immediately with full state
        if (response.state) {
          const currentGuest = response.state.guests.find(g => g.nickname === guestData.nickname)
          if (currentGuest) {
            setGuestData((prev) => (prev ? { 
              ...prev, 
              capital: currentGuest.capital,
              status: response.state.status,
              currentRound: response.state.currentRound,
              roundStatus: response.state.roundStatus,
              hasBidInCurrentRound: currentGuest.hasBidInCurrentRound
            } : null))
            
            // Î≥ÄÎèôÏûÖÏ∞∞ÏóêÏÑúÎäî Ìï≠ÏÉÅ ÏûÖÏ∞∞ Í∞ÄÎä• (Î≤ÑÌäºÏóêÏÑú ÏßÅÏ†ë Ï≤¥ÌÅ¨)
            console.log("[Dynamic Guest] Post-bid dynamic - always setting canBid to true")
            setCanBid(true)
          }
        } else {
          // Fallback to simple update
          setGuestData((prev) => (prev ? { 
            ...prev, 
            capital: response.remainingCapital,
            hasBidInCurrentRound: response.hasBidInCurrentRound
          } : null))
          
          // Î≥ÄÎèôÏûÖÏ∞∞ÏóêÏÑúÎäî Ìï≠ÏÉÅ ÏûÖÏ∞∞ Í∞ÄÎä•
          setCanBid(true)
        }
        
        setBidAmount("")
        
        console.log("[Dynamic Guest] Bid successful, updated guest data")
        toast({
          title: "ÏûÖÏ∞∞ ÏôÑÎ£å",
          description: `Î≥ÄÎèôÏûÖÏ∞∞Ïù¥ ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§. Îçî ÎÜíÏùÄ Í∏àÏï°ÏúºÎ°ú Ïû¨ÏûÖÏ∞∞ Í∞ÄÎä•Ìï©ÎãàÎã§. ÎÇ®ÏùÄ ÏûêÎ≥∏: ${response.remainingCapital?.toLocaleString() || guestData.capital?.toLocaleString()}Ïõê`,
        })
      } else {
        console.log("[Dynamic Guest] Bid failed:", response.error)
        toast({
          title: "ÏûÖÏ∞∞ Ïã§Ìå®",
          description: response.error || "ÏûÖÏ∞∞Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.",
          variant: "destructive",
        })
      }
    } catch (error) {
      console.error("[Dynamic Guest] Failed to place bid:", error)
      toast({
        title: "Ïó∞Í≤∞ Ïò§Î•ò",
        description: "ÏÑúÎ≤ÑÏóê Ïó∞Í≤∞Ìï† Ïàò ÏóÜÏäµÎãàÎã§.",
        variant: "destructive",
      })
    } finally {
      setIsBidding(false)
    }
  }

  if (!isConnected) {
    return (
      <div className="min-h-screen bg-background flex items-center justify-center p-4">
        <Card className="w-full max-w-md">
          <CardContent className="pt-6">
            <div className="text-center space-y-4">
              <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto"></div>
              <div className="text-lg font-semibold">
                {error ? "Ïó∞Í≤∞ ÏÉÅÌÉú ÌôïÏù∏ Ï§ë..." : "ÏÑúÎ≤ÑÏóê Ïó∞Í≤∞ Ï§ë..."}
              </div>
              {error && (
                <Alert>
                  <AlertCircle className="h-4 w-4" />
                  <AlertDescription>{error}</AlertDescription>
                </Alert>
              )}
              <div className="text-sm text-muted-foreground">
                Ïû†ÏãúÎßå Í∏∞Îã§Î†§Ï£ºÏÑ∏Ïöî. ÏûêÎèôÏúºÎ°ú Ïû¨Ïó∞Í≤∞ÏùÑ ÏãúÎèÑÌï©ÎãàÎã§.
              </div>
              <div className="flex justify-center space-x-2">
                <Button 
                  onClick={() => window.location.reload()}
                  variant="outline"
                  size="sm"
                >
                  ÏÉàÎ°úÍ≥†Ïπ®
                </Button>
                <Button 
                  onClick={() => {
                    setError("")
                    setIsConnected(true)
                  }}
                  size="sm"
                >
                  Í≥ÑÏÜç ÏßÑÌñâ
                </Button>
              </div>
            </div>
          </CardContent>
        </Card>
      </div>
    )
  }

  return (
    <div className="min-h-screen">
      {/* Join Modal */}
      <Dialog open={showJoinModal} onOpenChange={setShowJoinModal}>
        <DialogContent className="sm:max-w-md">
          <DialogHeader>
            <DialogTitle>Î≥ÄÎèôÏûÖÏ∞∞ Í≤ΩÎß§ Ï∞∏Ïó¨</DialogTitle>
            <DialogDescription>
              ÎãâÎÑ§ÏûÑÏùÑ ÏûÖÎ†•ÌïòÍ≥† Î≥ÄÎèôÏûÖÏ∞∞ Í≤ΩÎß§Ïóê Ï∞∏Ïó¨ÌïòÏÑ∏Ïöî. Ïã§ÏãúÍ∞Ñ Ïû¨ÏûÖÏ∞∞Ïù¥ Í∞ÄÎä•Ìï©ÎãàÎã§.
            </DialogDescription>
          </DialogHeader>
          <div className="space-y-4">
            <div className="space-y-2">
              <Label htmlFor="nickname">ÎãâÎÑ§ÏûÑ</Label>
              <Input
                id="nickname"
                placeholder="ÎãâÎÑ§ÏûÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî"
                value={nickname}
                onChange={(e) => setNickname(e.target.value)}
                onKeyDown={(e) => e.key === "Enter" && handleJoinRoom()}
                maxLength={10}
                disabled={isJoining}
              />
            </div>
            {error && (
              <Alert variant="destructive">
                <AlertCircle className="h-4 w-4" />
                <AlertDescription>{error}</AlertDescription>
              </Alert>
            )}
            <Button
              onClick={handleJoinRoom}
              className="w-full"
              disabled={isJoining || !nickname.trim()}
            >
              {isJoining ? "Ï∞∏Ïó¨ Ï§ë..." : "Î≥ÄÎèôÏûÖÏ∞∞ Í≤ΩÎß§ Ï∞∏Ïó¨ÌïòÍ∏∞"}
            </Button>
          </div>
        </DialogContent>
      </Dialog>

      {guestData && (
        <AuctionItemProvider roomId={roomId}>
          <GuestLayout roomId={roomId} guestName={guestData.nickname}>
            <div className="max-w-4xl mx-auto space-y-6">
          {/* Header */}
          <Card>
            <CardHeader>
              <CardTitle className="flex items-center justify-between">
                <div className="flex items-center gap-2">
                  <Wallet className="h-6 w-6" />
                  Î≥ÄÎèôÏûÖÏ∞∞ Í≤ΩÎß§ Ï∞∏Ïó¨
                </div>
                {guestData.status === 'ACTIVE' && (
                  <Badge 
                    variant={guestData.roundStatus === 'ACTIVE' ? 'default' : 'secondary'}
                    className="text-base px-4 py-2"
                  >
                    {guestData.roundStatus === 'ACTIVE' ? 'üî• ÎùºÏö¥Îìú ÏßÑÌñâ Ï§ë' : '‚è∏Ô∏è ÎåÄÍ∏∞ Ï§ë'}
                  </Badge>
                )}
              </CardTitle>
              <CardDescription>
                ÏïàÎÖïÌïòÏÑ∏Ïöî, <strong>{guestData.nickname}</strong>Îãò! Î≥ÄÎèôÏûÖÏ∞∞ Í≤ΩÎß§Ïóê Ï∞∏Ïó¨ÌïòÏÖ®ÏäµÎãàÎã§.
                Ïã§ÏãúÍ∞Ñ Ïû¨ÏûÖÏ∞∞Ïù¥ Í∞ÄÎä•Ìï©ÎãàÎã§.
              </CardDescription>
            </CardHeader>
            <CardContent>
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div className="text-center">
                  <div className="text-2xl font-bold text-primary">
                    {guestData.capital.toLocaleString()}Ïõê
                  </div>
                  <div className="text-sm text-muted-foreground">Î≥¥Ïú† ÏûêÎ≥∏</div>
                </div>
                <div className="text-center">
                  <div className="text-2xl font-bold">
                    {guestData.currentRound || 0}
                  </div>
                  <div className="text-sm text-muted-foreground">ÌòÑÏû¨ ÎùºÏö¥Îìú</div>
                </div>
                <div className="text-center">
                  <Badge variant={guestData.status === "ACTIVE" ? "default" : "secondary"}>
                    {guestData.status === "ACTIVE" ? "Î≥ÄÎèôÏûÖÏ∞∞ ÏßÑÌñâ Ï§ë" : "ÎåÄÍ∏∞ Ï§ë"}
                  </Badge>
                  <div className="text-sm text-muted-foreground mt-1">Í≤ΩÎß§ ÏÉÅÌÉú</div>
                </div>
              </div>
            </CardContent>
          </Card>

          {/* Î≥ÄÎèôÏûÖÏ∞∞ ÏµúÍ≥† ÏûÖÏ∞∞ Ï†ïÎ≥¥ */}
          {guestData.status === "ACTIVE" && guestData.roundStatus === "ACTIVE" && (
            <Card className="border-emerald-200 bg-emerald-50/30">
              <CardHeader className="pb-3">
                <CardTitle className="flex items-center gap-2 text-emerald-700">
                  <TrendingUp className="h-5 w-5" />
                  ÌòÑÏû¨ ÏµúÍ≥† ÏûÖÏ∞∞
                </CardTitle>
              </CardHeader>
              <CardContent>
                {currentHighestBid ? (
                  <div className="flex items-center justify-between">
                    <div>
                      <p className="text-lg font-semibold text-emerald-800">
                        {currentHighestBid.nickname}
                      </p>
                      <p className="text-sm text-muted-foreground">ÏµúÍ≥† ÏûÖÏ∞∞Ïûê</p>
                    </div>
                    <div className="text-right">
                      <p className="text-2xl font-bold text-emerald-600">
                        {currentHighestBid.amount.toLocaleString()}Ïõê
                      </p>
                      <p className="text-sm text-muted-foreground">ÏûÖÏ∞∞ Í∏àÏï°</p>
                    </div>
                  </div>
                ) : (
                  <div className="text-center text-muted-foreground">
                    <p>ÏïÑÏßÅ ÏûÖÏ∞∞ÏûêÍ∞Ä ÏóÜÏäµÎãàÎã§</p>
                    <p className="text-sm">Ï≤´ Î≤àÏß∏ ÏûÖÏ∞∞ÏûêÍ∞Ä ÎêòÏñ¥Î≥¥ÏÑ∏Ïöî!</p>
                  </div>
                )}
                {/* Î≥ÄÎèôÏûÖÏ∞∞ÏóêÏÑú ÌòÑÏû¨ ÏÇ¨Ïö©ÏûêÍ∞Ä ÏµúÍ≥† ÏûÖÏ∞∞ÏûêÏùº Îïå ÏïåÎ¶º */}
                {currentHighestBid && currentHighestBid.nickname === guestData.nickname && (
                  <div className="mt-3 p-3 bg-emerald-50 border border-emerald-200 rounded-lg text-center">
                    <p className="text-emerald-700 font-semibold">üèÜ ÌòÑÏû¨ ÏµúÍ≥† ÏûÖÏ∞∞ÏûêÏûÖÎãàÎã§!</p>
                    <p className="text-sm text-emerald-600">Îçî ÎÜíÏùÄ ÏûÖÏ∞∞Ïù¥ Îì§Ïñ¥Ïò¨ ÎïåÍπåÏßÄ 1ÏúÑÎ•º Ïú†ÏßÄÌïòÏÑ∏Ïöî.</p>
                  </div>
                )}
              </CardContent>
            </Card>
          )}

          {/* Current Round Item (click to enlarge) */}
          {guestData.status === "ACTIVE" && (
            <Card onClick={() => currentRoundItem && setIsItemDialogOpen(true)} className="cursor-pointer hover:shadow-lg transition-shadow">
              <CardHeader>
                <CardTitle className="flex items-center gap-2">
                  <Package className="h-5 w-5" />
                  ÌòÑÏû¨ Í≤ΩÎß§ Î¨ºÌíà
                </CardTitle>
                <CardDescription>
                  ÎùºÏö¥Îìú {guestData.currentRound}Ïùò Í≤ΩÎß§ Î¨ºÌíàÏûÖÎãàÎã§.
                </CardDescription>
              </CardHeader>
              <CardContent>
                {currentRoundItem ? (
                  <div className="space-y-4">
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div>
                        <h3 className="font-semibold text-2xl text-gray-900">{currentRoundItem.item.name}</h3>
                        <p className="text-lg text-gray-700 mt-3 leading-relaxed">{currentRoundItem.item.description}</p>
                        {currentRoundItem.item.startingPrice && (
                          <div className="mt-2">
                            <span className="text-sm text-muted-foreground">ÏãúÏûëÍ∞Ä: </span>
                            <span className="font-semibold text-primary">
                              {currentRoundItem.item.startingPrice.toLocaleString()}Ïõê
                            </span>
                          </div>
                        )}
                      </div>
                      {currentRoundItem.item.image && (
                        <div className="flex justify-center">
                          <img 
                            src={currentRoundItem.item.image} 
                            alt={currentRoundItem.item.name}
                            className="max-w-full h-64 object-contain rounded-xl border-2 shadow"
                          />
                        </div>
                      )}
                    </div>
                    {currentRoundItem.item.ownerNickname && (
                      <div className="text-sm text-muted-foreground">
                        Îì±Î°ùÏûê: {currentRoundItem.item.ownerNickname}
                      </div>
                    )}
                  </div>
                ) : (
                  <div className="text-center py-12">
                    <Package className="h-16 w-16 text-gray-400 mx-auto mb-6" />
                    <p className="text-lg text-gray-500 mb-2">ÌòÑÏû¨ Í≤ΩÎß§ Î¨ºÌíàÏù¥ Îì±Î°ùÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.</p>
                    <p className="text-sm text-gray-400">Ìò∏Ïä§Ìä∏Í∞Ä Î¨ºÌíàÏùÑ Îì±Î°ùÌïòÎ©¥ Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§.</p>
                  </div>
                )}
              </CardContent>
            </Card>
          )}

          {/* ÌôïÎåÄ Îã§Ïù¥ÏñºÎ°úÍ∑∏ */}
          <Dialog open={isItemDialogOpen} onOpenChange={setIsItemDialogOpen}>
            <DialogContent className="max-w-3xl w-[95vw]">
              <DialogHeader>
                <DialogTitle className="text-2xl font-bold">{currentRoundItem?.item?.name || 'ÌòÑÏû¨ Í≤ΩÎß§ Î¨ºÌíà'}</DialogTitle>
              </DialogHeader>
              {currentRoundItem && (
                <div className="space-y-4">
                  {currentRoundItem.item.image && (
                    <img
                      src={currentRoundItem.item.image}
                      alt={currentRoundItem.item.name}
                      className="w-full max-h-[60vh] object-contain rounded-xl border"
                    />
                  )}
                  <p className="text-lg text-gray-800 leading-relaxed whitespace-pre-wrap">
                    {currentRoundItem.item.description}
                  </p>
                </div>
              )}
            </DialogContent>
          </Dialog>

          {/* Bidding Section */}
          {guestData.status === "ACTIVE" && guestData.roundStatus === "ACTIVE" ? (
            <Card>
              <CardHeader>
                <CardTitle className="flex items-center gap-2">
                  <TrendingUp className="h-5 w-5" />
                  Î≥ÄÎèôÏûÖÏ∞∞ÌïòÍ∏∞ (Ïã§ÏãúÍ∞Ñ Ïû¨ÏûÖÏ∞∞ Í∞ÄÎä•)
                </CardTitle>
                <CardDescription>
                  <div className="flex items-center gap-2">
                    <Clock className="h-4 w-4" />
                    ÎùºÏö¥Îìú {guestData.currentRound}Ïù¥ ÏßÑÌñâ Ï§ëÏûÖÎãàÎã§
                    <Badge variant="outline">
                      {guestData.roundStatus === "ACTIVE" ? "Ïã§ÏãúÍ∞Ñ ÏûÖÏ∞∞ Í∞ÄÎä•" : "ÏûÖÏ∞∞ Î∂àÍ∞Ä"}
                    </Badge>
                  </div>
                  <div className="space-y-2">
                    <Label htmlFor="bid-amount">ÏûÖÏ∞∞ Í∏àÏï°</Label>
                    <Input
                      id="bid-amount"
                      type="number"
                      placeholder={currentHighestBid ? `${(currentHighestBid.amount + 1).toLocaleString()}Ïõê Ïù¥ÏÉÅ ÏûÖÎ†•` : "ÏûÖÏ∞∞Ìï† Í∏àÏï°ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî"}
                      value={bidAmount}
                      onChange={(e) => setBidAmount(e.target.value)}
                      onKeyDown={(e) => e.key === "Enter" && handlePlaceBid()}
                      min={currentHighestBid ? currentHighestBid.amount + 1 : 1}
                      max={guestData.capital}
                    />
                  </div>
                  <Button
                    onClick={handlePlaceBid}
                    className="w-full"
                    size="lg"
                    disabled={
                      isBidding || 
                      guestData.capital <= 0 || 
                      guestData.roundStatus !== "ACTIVE"
                    }
                  >
                    {isBidding ? "ÏûÖÏ∞∞ Ï§ë..." : 
                     guestData.capital <= 0 ? "ÏûêÎ≥∏Í∏à Î∂ÄÏ°±" : 
                     guestData.roundStatus !== "ACTIVE" ? "ÎùºÏö¥Îìú ÎåÄÍ∏∞ Ï§ë" : 
                     (currentHighestBid?.nickname === guestData.nickname ? "Îçî ÎÜíÏùÄ Í∏àÏï°ÏúºÎ°ú Ïû¨ÏûÖÏ∞∞" : "ÏûÖÏ∞∞ÌïòÍ∏∞")}
                  </Button>
                  {guestData.capital <= 0 && (
                    <Alert variant="destructive">
                      <AlertCircle className="h-4 w-4" />
                      <AlertDescription>ÏûêÎ≥∏Í∏àÏù¥ Î™®Îëê ÏÜåÏßÑÎêòÏóàÏäµÎãàÎã§. Îçî Ïù¥ÏÉÅ ÏûÖÏ∞∞Ìï† Ïàò ÏóÜÏäµÎãàÎã§.</AlertDescription>
                    </Alert>
                  )}
                </CardDescription>
              </CardHeader>
            </Card>
          ) : guestData.status === "ACTIVE" ? (
            <Alert>
              <Clock className="h-4 w-4" />
              <AlertDescription>
                Î≥ÄÎèôÏûÖÏ∞∞ Í≤ΩÎß§Í∞Ä ÏãúÏûëÎêòÏóàÏäµÎãàÎã§. Ìò∏Ïä§Ìä∏Í∞Ä ÎùºÏö¥ÎìúÎ•º ÏãúÏûëÌïòÎ©¥ ÏûÖÏ∞∞Ìï† Ïàò ÏûàÏäµÎãàÎã§.
                {guestData.currentRound && guestData.currentRound > 0 && (
                  <span className="block mt-2 text-sm">
                    ÌòÑÏû¨ ÎùºÏö¥Îìú: {guestData.currentRound} | 
                    ÏÉÅÌÉú: {guestData.roundStatus === "ACTIVE" ? "ÏßÑÌñâ Ï§ë" : "ÎåÄÍ∏∞ Ï§ë"}
                  </span>
                )}
              </AlertDescription>
            </Alert>
          ) : (
            <Alert>
              <Clock className="h-4 w-4" />
              <AlertDescription>
                Î≥ÄÎèôÏûÖÏ∞∞ Í≤ΩÎß§Í∞Ä ÏïÑÏßÅ ÏãúÏûëÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§. Ìò∏Ïä§Ìä∏Í∞Ä Í≤ΩÎß§Î•º ÏãúÏûëÌï† ÎïåÍπåÏßÄ Í∏∞Îã§Î†§Ï£ºÏÑ∏Ïöî.
              </AlertDescription>
            </Alert>
          )}

          {/* Round Results */}
          {roundResults && (
            <Card>
              <CardHeader>
                <CardTitle className="flex items-center gap-2">
                  <TrendingUp className="h-5 w-5" />
                  ÎùºÏö¥Îìú {roundResults.round} Í≤∞Í≥º Í≥µÍ∞ú
                </CardTitle>
                <CardDescription>Î™®Îì† ÏûÖÏ∞∞ Í∏àÏï°Ïù¥ Í≥µÍ∞úÎêòÏóàÏäµÎãàÎã§</CardDescription>
              </CardHeader>
              <CardContent>
                <div className="space-y-4">
                  {roundResults.winner ? (
                    <Alert className="border-green-200 bg-green-50">
                      <AlertDescription className="text-center">
                        <div className="text-2xl font-bold text-green-600 mb-2">üèÜ ÎÇôÏ∞∞Ïûê</div>
                        <div className="text-xl font-semibold">{roundResults.winner.nickname}</div>
                        <div className="text-lg text-green-600">
                          {roundResults.winner.amount?.toLocaleString()}Ïõê
                        </div>
                      </AlertDescription>
                    </Alert>
                  ) : (
                    <Alert>
                      <AlertDescription className="text-center">
                        <div className="text-lg">Ïù¥Î≤à ÎùºÏö¥ÎìúÏóêÎäî ÏûÖÏ∞∞ÏûêÍ∞Ä ÏóÜÏóàÏäµÎãàÎã§.</div>
                      </AlertDescription>
                    </Alert>
                  )}
                  
                  <div className="space-y-2">
                    <h4 className="font-semibold text-lg">Ï†ÑÏ≤¥ ÏûÖÏ∞∞ ÎÇ¥Ïó≠ (Í∏àÏï° Í≥µÍ∞ú)</h4>
                    {roundResults.bids.map((bid, index) => (
                      <Alert key={`${bid.nickname}-${bid.timestamp}-${index}`} className="py-3">
                        <AlertDescription className="flex items-center justify-between">
                          <div className="flex items-center gap-2">
                            <span className="font-bold text-lg">{bid.nickname}</span>
                            {index === 0 && <Badge variant="default">1ÏúÑ</Badge>}
                            {index === 1 && <Badge variant="secondary">2ÏúÑ</Badge>}
                            {index === 2 && <Badge variant="outline">3ÏúÑ</Badge>}
                          </div>
                          <div className="text-right">
                            <div className="font-mono font-bold text-lg">{bid.amount?.toLocaleString()}Ïõê</div>
                            <div className="text-xs text-muted-foreground">
                              {new Date(bid.timestamp).toLocaleTimeString()}
                            </div>
                          </div>
                        </AlertDescription>
                      </Alert>
                    ))}
                  </div>
                </div>
              </CardContent>
            </Card>
          )}

          {/* Instructions */}
          <Card>
            <CardHeader>
              <CardTitle>Î≥ÄÎèôÏûÖÏ∞∞ Í≤ΩÎß§ Í∑úÏπô</CardTitle>
            </CardHeader>
            <CardContent className="space-y-2 text-sm text-muted-foreground">
              <p>‚Ä¢ Î≥¥Ïú† ÏûêÎ≥∏Í∏à ÎÇ¥ÏóêÏÑúÎßå ÏûÖÏ∞∞Ìï† Ïàò ÏûàÏäµÎãàÎã§.</p>
              <p>‚Ä¢ <strong>Î≥ÄÎèôÏûÖÏ∞∞: ÎùºÏö¥Îìú Ï§ë Ïñ∏Ï†úÎì†ÏßÄ Ïû¨ÏûÖÏ∞∞Ïù¥ Í∞ÄÎä•Ìï©ÎãàÎã§.</strong></p>
              <p>‚Ä¢ Îçî ÎÜíÏùÄ Í∏àÏï°ÏúºÎ°úÎßå ÏûÖÏ∞∞Ìï† Ïàò ÏûàÏäµÎãàÎã§.</p>
              <p>‚Ä¢ Îã§Î•∏ ÏÇ¨ÎûåÏù¥ Îçî ÎÜíÏùÄ Í∏àÏï°ÏùÑ ÏûÖÏ∞∞ÌïòÎ©¥ ÏûêÎèôÏúºÎ°ú ÏûêÎ≥∏Í∏àÏù¥ ÌôòÏõêÎê©ÎãàÎã§.</p>
              <p>‚Ä¢ Î™®Îì† ÏûÖÏ∞∞ÏùÄ Ïã§ÏãúÍ∞ÑÏúºÎ°ú Ìò∏Ïä§Ìä∏ ÌôîÎ©¥Ïóê ÌëúÏãúÎê©ÎãàÎã§.</p>
              <p>‚Ä¢ Í≤ΩÎß§Îäî Ìò∏Ïä§Ìä∏Í∞Ä ÏãúÏûëÌïòÍ≥† Ï¢ÖÎ£åÌï©ÎãàÎã§.</p>
            </CardContent>
          </Card>
            </div>
          </GuestLayout>
        </AuctionItemProvider>
      )}
    </div>
  )
}
